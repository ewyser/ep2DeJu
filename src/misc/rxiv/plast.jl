#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
function plast!(σ,ϵ,epII,coh,phi,nmp,Del,Hp,cr)
    iDel = inv(Del)
    for p in 1:nmp
        c   = coh[p]+Hp*epII[p]
        if c<cr
            c = cr
        end
        ϕ  = phi[p]
        σxx= σ[1,p]
        σyy= σ[2,p]
        σxy= σ[4,p]
        Δσ = σxx-σyy
        τ  = sqrt(0.25*Δσ^2+σxy^2)
        σt = 0.5*(σxx+σyy)
        f  = τ+σt*sin(ϕ)-c*cos(ϕ)
        
        if f>0.0
            if σt <= (c/tan(ϕ))
                β = abs(c*cos(ϕ)-sin(ϕ)*σt)/τ
                σxxn = σt+β*Δσ/2
                σyyn = σt-β*Δσ/2
                σxyn = β*σxy
            else
                σxxn = c/tan(ϕ)
                σyyn = c/tan(ϕ)
                σxyn = 0.0
            end
            Δσxx = σxxn-σxx
            Δσyy = σyyn-σyy
            Δσxy = σxyn-σxy
            Δϵxx = iDel[1,1]*Δσxx+iDel[1,2]*Δσyy+iDel[1,4]*Δσxy
            Δϵyy = iDel[2,1]*Δσxx+iDel[2,2]*Δσyy+iDel[2,4]*Δσxy
            Δϵxy = iDel[4,1]*Δσxx+iDel[4,2]*Δσyy+iDel[4,4]*Δσxy

            epII[p]+= sqrt(2/3*(Δϵxx^2+Δϵyy^2)+2*Δϵxy^2)

            σ[1,p] = σxxn
            σ[2,p] = σyyn
            σ[4,p] = σxyn    
        end
        
    end
end
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
function CPAplast!(τ,ϵ,epII,coh,phi,np,Del,Hp,cr)
    ψ    = 0.5*pi/180.0
    ftol = 1e-6
    ηtol = 1e4
    @threads for p in 1:np
        ϕ   = phi[p]
        H   = cos(ϕ)*Hp
        ϵII0= epII[p]
        c0  = coh[p]+Hp*ϵII0
        if c0<cr
            c0 = cr
        end
        σm  = 0.5*(τ[1,p]+τ[2,p])
        τII = sqrt(0.25*(τ[1,p]-τ[2,p])^2+τ[4,p]^2)
        f   = τII+σm*sin(ϕ)-c0*cos(ϕ)
        e   = [0 f]
        if f>0.0
            ϵII = ϵII0
            Δϵ  = zeros(Float64,4,1)
            η   = 0
            while abs(f)>ftol
                η  += 1
                ∂σf = [ (τ[1,p]-τ[2,p])/(4*τII)+sin(ϕ)/2;
                       -(τ[1,p]-τ[2,p])/(4*τII)+sin(ϕ)/2;
                        0.0                             ;
                        τ[4,p]/τII                      ]
                ∂σg = [ (τ[1,p]-τ[2,p])/(4*τII)+sin(ψ)/2;
                       -(τ[1,p]-τ[2,p])/(4*τII)+sin(ψ)/2;
                        0.0                             ;
                        τ[4,p]/τII                      ] 

                Δγ  = f/(H+∂σf'*Del*∂σg)
                Δσ  = Δγ*Del*∂σg
                Δϵ  = Δϵ+Del\Δσ
                τ[:,p] -= Δσ
                ϵII = ϵII0+sqrt(2/3*(Δϵ[1]^2+Δϵ[2]^2+Δϵ[3]^2+2*Δϵ[4]^2))
                c0  = coh[p]+Hp*ϵII
                if c0<cr
                    c0 = cr
                end
                σm = 0.5*(τ[1,p]+τ[2,p])
                τII = sqrt(0.25*(τ[1,p]-τ[2,p])^2+τ[4,p]^2)
                f = τII+σm*sin(ϕ)-c0*cos(ϕ)
                if η>ηtol
                    @printf("\nCPA: max(η_it)>%d",ηtol)
                    @printf("\n     f = %.6f",f)
                    @printf("\n     program killed...")
                    exit(1)
                end
            end
            ϵ[:,p] -= Δϵ
            epII[p] = ϵII 
        end
    end
end
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------------
function bEplast!(τ,ϵ,epII,coh,phi,np,Del,Hp,cr)
    ψ    = 0.5*pi/180.0
    Hp   = 0.0
    ftol = 1e-6
    ηtol = 1e4
    I    = [1 0 0 0; 0 1 0 0; 0 0 1 0; 0 0 0 1]
    @threads for p in 1:np
        ϕ   = phi[p]
        H   = cos(ϕ)*Hp
        ϵII0= epII[p]
        c0  = coh[p]+Hp*ϵII0
        if c0<cr
            c0 = cr
        end
        σm  = 0.5*(τ[1,p]+τ[2,p])
        τII = sqrt(0.25*(τ[1,p]-τ[2,p])^2+τ[4,p]^2)
        f   = τII+σm*sin(ϕ)-c0*cos(ϕ)
        e   = [0 f]
        σ0  = τ[:,p]
        σ   = σ0
        if f>0.0
            δϵ  = zeros(Float64,4,1)
            δϵII= 0.0
            δγ  = 0.0
            η   = 1
            while(abs(f)>ftol && η<10)
                ∂σf = [ (σ[1]-σ[2])/(4*τII)+sin(ϕ)/2;
                       -(σ[1]-σ[2])/(4*τII)+sin(ϕ)/2;
                        0.0                         ;
                        σ[4]/τII                    ]
                ∂∂σf= [ 1/(4*τII)                   ;
                       -1/(4*τII)                   ;
                        0.0                         ;
                        1/(1*τII)                   ]
                ∂σg = [ (σ[1]-σ[2])/(4*τII)+sin(ψ)/2;
                       -(σ[1]-σ[2])/(4*τII)+sin(ψ)/2;
                        0.0                         ;
                        σ[4]/τII                    ] 
                ∂∂σg= ∂∂σf
                
                Rσ    = σ-σ0+δγ*Del*∂σg
                #=
                Rf    = f
                R     = [Rσ;Rf]
                ∂R∂σ  = I+δγ*Del*∂∂σg
                ∂R∂γ  = Del*(∂σg+δγ*∂∂σg)
                ∂Rf∂σ = ∂σf'
                ∂Rf∂γ = -h
                B     = [σ;δγ]-[∂R∂σ ∂R∂γ;∂Rf∂σ ∂Rf∂γ]\R
                
                σ     = B[1:4]
                δγ    = B[5]
                δϵ    = Del\(σ0 - σ)
                δϵII  = sqrt(2/3*(δϵ[1]^2+δϵ[2]^2+δϵ[3]^2+2*δϵ[4]^2))
                c0    = coh[p]+Hp*ϵII0
                if c0<cr
                    c0 = cr
                end
                σm  = 0.5*(σ[1]+σ[2])
                τII = sqrt(0.25*(σ[1]-σ[2])^2+σ[4]^2)
                f   = τII+σm*sin(ϕ)-c0*cos(ϕ)
                =#
                η += 1 
            end
            ϵ[:,p] -= δϵ
            epII[p] = δϵII
            τ[:,p]  = σ 
        end
    end
end